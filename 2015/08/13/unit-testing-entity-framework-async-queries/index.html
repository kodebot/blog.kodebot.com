<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-134738941-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>Unit Testing Entity Framework async Queries | kodebot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="IntroductionIn my last article, we have seen how to unit test Entity Framework queries. Now, let’s look at how to unit test asyn queries.When using async tasks, if we don’t use it all the way then we">
<meta name="keywords" content="unit-testing,entity-framework">
<meta property="og:type" content="article">
<meta property="og:title" content="Unit Testing Entity Framework async Queries">
<meta property="og:url" content="http://kodebot.com/2015/08/13/unit-testing-entity-framework-async-queries/index.html">
<meta property="og:site_name" content="kodebot">
<meta property="og:description" content="IntroductionIn my last article, we have seen how to unit test Entity Framework queries. Now, let’s look at how to unit test asyn queries.When using async tasks, if we don’t use it all the way then we">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-02-25T07:14:55.648Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unit Testing Entity Framework async Queries">
<meta name="twitter:description" content="IntroductionIn my last article, we have seen how to unit test Entity Framework queries. Now, let’s look at how to unit test asyn queries.When using async tasks, if we don’t use it all the way then we">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-3809588371499381",
    enable_page_level_ads: true
  });
  </script>

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">kodebot</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">A pragmatic developer&#39;s blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://kodebot.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-unit-testing-entity-framework-async-queries" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/08/13/unit-testing-entity-framework-async-queries/" class="article-date">
  <time datetime="2015-08-13T17:53:24.000Z" itemprop="datePublished">2015-08-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/programming/">programming</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unit Testing Entity Framework async Queries
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In my <a href="/2015/08/10/unit-testing-entity-framework-queries/">last article</a>, we have seen how to unit test Entity Framework queries. Now, let’s look at how to unit test asyn queries.<br>When using async tasks, if we don’t use it all the way then we are not using async tasks properly. For example, if you have async action method in your controller which queries database synchronously to send some data to the requester, then we are NOT using async properly as the thread is blocked during database operation. So, to take full advantage of async tasks, we have to use async tasks all the way wherever it is applicable. Fortunately, we get async query support starting from <a href="https://msdn.microsoft.com/en-us/data/jj819165.aspx" target="_blank" rel="noopener">Entity Framework 6</a>.</p>
<h2 id="Async-Queries"><a href="#Async-Queries" class="headerlink" title="Async Queries"></a>Async Queries</h2><p>Let’s take the query we have written last time and convert it into async.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IQueryable&lt;Movie&gt; <span class="title">GetTopFiveMovies</span>(<span class="params"><span class="keyword">int</span> year</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> _moviesContext.Movies</span><br><span class="line">        .Where(movie =&gt; movie.Year == year)</span><br><span class="line">        .OrderByDescending(movie =&gt; movie.Rating)</span><br><span class="line">        .Take(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The above method takes the top five movies for a given year synchronously. To change this to run asynchronously, we need to force the query execution using <code>ToListAsync()</code> extension method. The async version of the method would look like this</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;Movie&gt;&gt; GetTopFiveMovies(<span class="keyword">int</span> year)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> _moviesContext.Movies</span><br><span class="line">        .Where(movie =&gt; movie.Year == year)</span><br><span class="line">        .OrderByDescending(movie =&gt; movie.Rating)</span><br><span class="line">        .Take(<span class="number">5</span>)</span><br><span class="line">        .ToListAsync();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h2><p>In order to replace underlying data source with in-memory list, the list should implement <code>IDbAsyncEnumerable</code> and <code>IQueryable</code>. We can simply convert <code>List</code> into <code>IQueryable</code> using <code>AsQueryable()</code> extension method. But it is not straight forward to implement <code>IDbAsyncEnumerable</code>. The easiest way to acheive this is by wrapping our <code>List</code> data in a class which implements <code>IDbAsyncEnumerable</code>.</p>
<p>The class we create implementing <code>IDbAsyncEnumerable</code> should have <code>GetAsyncEnumerator()</code> method returning an enumerator implementing <code>IDbAsyncEnumerator</code> and <code>Provider</code> property should return a QueryProvider which implements <code>IDbAsyncQueryProvider</code>. So we need three fake/test-double classes as follows</p>
<figure class="highlight csharp"><figcaption><span>FakeDbAsyncEnumerable</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class FakeDbAsyncEnumerable&lt;T&gt; : EnumerableQuery&lt;T&gt;, IDbAsyncEnumerable&lt;T&gt;, IQueryable&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FakeDbAsyncEnumerable</span>(<span class="params">IEnumerable&lt;T&gt; enumerable</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">enumerable</span>)</span></span><br><span class="line"><span class="function">    </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FakeDbAsyncEnumerable</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line"><span class="function">        : <span class="title">base</span>(<span class="params">expression</span>)</span></span><br><span class="line"><span class="function">    </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IDbAsyncEnumerator&lt;T&gt; <span class="title">GetAsyncEnumerator</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FakeDbAsyncEnumerator&lt;T&gt;(<span class="keyword">this</span>.AsEnumerable().GetEnumerator());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IDbAsyncEnumerator IDbAsyncEnumerable.GetAsyncEnumerator()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> GetAsyncEnumerator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IQueryProvider IQueryable.Provider</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> FakeDbAsyncQueryProvider&lt;T&gt;(<span class="keyword">this</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><figcaption><span>FakeDbAsyncEnumerator</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> public class FakeDbAsyncEnumerator&lt;T&gt; : IDbAsyncEnumerator&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IEnumerator&lt;T&gt; _localEnumerator;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FakeDbAsyncEnumerator</span>(<span class="params">IEnumerator&lt;T&gt; localEnumerator</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _localEnumerator = localEnumerator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _localEnumerator.Dispose();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task&lt;<span class="keyword">bool</span>&gt; <span class="title">MoveNextAsync</span>(<span class="params">CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Task.FromResult(_localEnumerator.MoveNext());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T Current</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _localEnumerator.Current; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">object</span> IDbAsyncEnumerator.Current</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> Current; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><figcaption><span>FakeDbAsyncQueryProvider</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class FakeDbAsyncQueryProvider&lt;T&gt; : IDbAsyncQueryProvider</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IQueryProvider _localQueryProvider;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">internal</span> <span class="title">FakeDbAsyncQueryProvider</span>(<span class="params">IQueryProvider localQueryProvider</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        _localQueryProvider = localQueryProvider;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IQueryable <span class="title">CreateQuery</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FakeDbAsyncEnumerable&lt;T&gt;(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> IQueryable&lt;TElement&gt; CreateQuery&lt;TElement&gt;(Expression expression)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FakeDbAsyncEnumerable&lt;TElement&gt;(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">object</span> <span class="title">Execute</span>(<span class="params">Expression expression</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _localQueryProvider.Execute(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> TResult Execute&lt;TResult&gt;(Expression expression)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> _localQueryProvider.Execute&lt;TResult&gt;(expression);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task&lt;<span class="keyword">object</span>&gt; <span class="title">ExecuteAsync</span>(<span class="params">Expression expression, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Task.FromResult(Execute(expression));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Task&lt;TResult&gt; ExecuteAsync&lt;TResult&gt;(Expression expression, CancellationToken cancellationToken)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Task.FromResult(Execute&lt;TResult&gt;(expression));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, we just need to create our data list and wrap it in <code>FakeDbAsyncEnumerable</code> instance and replace all the properties used by LINQ in <code>DbSet</code> instance with the one from <code>FakeDbAsyncEnumerable</code>.<br>Note, because we are using async query, we need to setup create setup to replace <code>GetAsyncEnumerator</code> rather than <code>GetEnumerator</code>.</p>
<p>The completed unit test would look like this</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">GetTopFiveMoviesShouldReturnTopFiveMoviesSuccessfully</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Fixture Setup</span></span><br><span class="line">    <span class="keyword">int</span> year = <span class="number">1999</span>;</span><br><span class="line">    <span class="comment">// test movie list data</span></span><br><span class="line">    <span class="keyword">var</span> movieList = <span class="keyword">new</span> List&lt;Movie&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">5</span>, Year=<span class="number">1999</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">5</span>, Year=<span class="number">1999</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">4</span>, Year=<span class="number">1999</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">1</span>, Year=<span class="number">1999</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">2</span>, Year=<span class="number">1999</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">4</span>, Year=<span class="number">1999</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> Movie() &#123;Id =<span class="number">1</span>, Name=<span class="string">"Test1"</span>, Rating =<span class="number">4</span>, Year=<span class="number">1991</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mock DbSet</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fakeAsynEnumerable = <span class="keyword">new</span> FakeDbAsyncEnumerable&lt;Movie&gt;(movieList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> mockDbSetMovies = <span class="keyword">new</span> Mock&lt;IDbSet&lt;Movie&gt;&gt;();</span><br><span class="line">    mockDbSetMovies.As&lt;IQueryable&gt;()</span><br><span class="line">        .Setup(mock =&gt; mock.Provider)</span><br><span class="line">        .Returns(fakeAsynEnumerable.AsQueryable().Provider);</span><br><span class="line"></span><br><span class="line">    mockDbSetMovies.As&lt;IQueryable&gt;()</span><br><span class="line">        .Setup(mock =&gt; mock.Expression)</span><br><span class="line">        .Returns(fakeAsynEnumerable.AsQueryable().Expression);</span><br><span class="line">    mockDbSetMovies.As&lt;IQueryable&gt;()</span><br><span class="line">        .Setup(mock =&gt; mock.ElementType)</span><br><span class="line">        .Returns(fakeAsynEnumerable.AsQueryable().ElementType);</span><br><span class="line"></span><br><span class="line">    mockDbSetMovies.As&lt;IDbAsyncEnumerable&gt;()</span><br><span class="line">        .Setup(mock =&gt; mock.GetAsyncEnumerator())</span><br><span class="line">        .Returns(((IDbAsyncEnumerable&lt;Movie&gt;)fakeAsynEnumerable).GetAsyncEnumerator());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mock DbContext</span></span><br><span class="line">    <span class="keyword">var</span> mockMovieContext = <span class="keyword">new</span> Mock&lt;IMoviesContext&gt;();</span><br><span class="line">    mockMovieContext.Setup(mock =&gt; mock.Movies).Returns(mockDbSetMovies.Object);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> MovieFinder(mockMovieContext.Object);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exercise System</span></span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> sut.GetTopFiveMovies(year);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify Outcome</span></span><br><span class="line">    Assert.AreEqual(<span class="number">5</span>, result.Count());</span><br><span class="line">    Assert.IsTrue(result.All(item =&gt; item.Year == year));</span><br><span class="line">    <span class="comment">// Fixture Teardown</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://kodebot.com/2015/08/13/unit-testing-entity-framework-async-queries/" data-id="cjsk0kp4u001zd4syhv5jqkdv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/entity-framework/">entity-framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unit-testing/">unit-testing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/09/27/exception-handling-in-nodejs/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Exception Handling in NodeJS
        
      </div>
    </a>
  
  
    <a href="/2015/08/10/unit-testing-entity-framework-queries/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Unit Testing Entity Framework Queries</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/programming/">programming</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/angularjs/">angularjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apache-cordova/">apache-cordova</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/asp-net/">asp.net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/automapper/">automapper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c#</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/design-pattern/">design-pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/e2e-testing/">e2e-testing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/entity-framework/">entity-framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es2015/">es2015</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/katana/">katana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mobile/">mobile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvc5/">mvc5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mvc6/">mvc6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nuget/">nuget</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/owin/">owin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/selenium/">selenium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sublime/">sublime</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typescript/">typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unit-testing/">unit-testing</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/angularjs/" style="font-size: 15.71px;">angularjs</a> <a href="/tags/apache-cordova/" style="font-size: 10px;">apache-cordova</a> <a href="/tags/asp-net/" style="font-size: 17.14px;">asp.net</a> <a href="/tags/automapper/" style="font-size: 10px;">automapper</a> <a href="/tags/c/" style="font-size: 14.29px;">c#</a> <a href="/tags/design-pattern/" style="font-size: 10px;">design-pattern</a> <a href="/tags/e2e-testing/" style="font-size: 10px;">e2e-testing</a> <a href="/tags/entity-framework/" style="font-size: 11.43px;">entity-framework</a> <a href="/tags/es2015/" style="font-size: 10px;">es2015</a> <a href="/tags/es6/" style="font-size: 10px;">es6</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/katana/" style="font-size: 10px;">katana</a> <a href="/tags/mobile/" style="font-size: 10px;">mobile</a> <a href="/tags/mvc5/" style="font-size: 14.29px;">mvc5</a> <a href="/tags/mvc6/" style="font-size: 11.43px;">mvc6</a> <a href="/tags/nodejs/" style="font-size: 11.43px;">nodejs</a> <a href="/tags/nuget/" style="font-size: 10px;">nuget</a> <a href="/tags/owin/" style="font-size: 10px;">owin</a> <a href="/tags/selenium/" style="font-size: 10px;">selenium</a> <a href="/tags/sublime/" style="font-size: 10px;">sublime</a> <a href="/tags/typescript/" style="font-size: 12.86px;">typescript</a> <a href="/tags/unit-testing/" style="font-size: 18.57px;">unit-testing</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/10/04/nodejs-loops/">NodeJs: Loops, Closure and Async Invocation</a>
          </li>
        
          <li>
            <a href="/2015/09/27/exception-handling-in-nodejs/">Exception Handling in NodeJS</a>
          </li>
        
          <li>
            <a href="/2015/08/13/unit-testing-entity-framework-async-queries/">Unit Testing Entity Framework async Queries</a>
          </li>
        
          <li>
            <a href="/2015/08/10/unit-testing-entity-framework-queries/">Unit Testing Entity Framework Queries</a>
          </li>
        
          <li>
            <a href="/2015/07/15/vs-tac-cordova-version/">VS-TAC - Cordova version</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 kodebot. All Rights Reserved.<br>
    </div>
    <div>
      All content on this website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/"> (CC BY-SA 3.0) Creative Commons Attribution-ShareAlike 3.0 Unported License</a>. All source code published here is licensed under the <a href="http://opensource.org/licenses/MIT"> MIT License</a> unless explicitly stated otherwise. The content is provided for educational and informational purposes only without any warranties, guarantees or conditions, of any kind, and may not be accurate, up to date or complete. Any use or reliance on any content or materials published, mentioned or linked here is at your own risk and the author/authors accept no liability or responsibility for.
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>